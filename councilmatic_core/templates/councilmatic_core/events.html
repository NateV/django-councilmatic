{% extends "base_with_margins.html" %}
{% load staticfiles %}
{% block title %}Events{% endblock %}
{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap-datepicker3.css' %}" />
{% endblock %}
{% block content %}

    <div class="row-fluid">
        <div class="col-sm-8 no-pad-mobile">
            <br/><br class="non-mobile-only"/>
            <div id="events-form" class="row">
                <div class="col-xs-10">
                    <form action='/events' method='GET'>
                      <div class="input-group" id='date-search'>
                            <span class="input-group-addon" id="sizing-addon3"><i class="fa fa-calendar" aria-hidden="true"></i></span>
                            <input type="text" class="form-control date-filter" placeholder="Select a month and year..." value="{{ date }}" readonly id="form_datetime" name="form_datetime">
                            <span class="input-group-btn">
                              <button class="btn btn-default btn-date" id="btn-search" type="submit"><i class="fa fa-search" aria-hidden="true"></i> <span class='hidden-sm hidden-xs'>Search</span></button>
                            </span>
                      </div>
                    </form>
                </div>
                <div class="col-xs-2">
                    <a href="{% url 'events' %}" class="btn btn-teal d-inline-block"><i class="fa fa-repeat" aria-hidden="true"></i><span class="hidden-xs"> Reset</span></a>
                </div>
            </div>

            {% if not show_upcoming %}
                {% if month_events %}
                    <h2>{{ CITY_VOCAB.EVENTS }}: {{ this_start_date | date:"F Y"}}</h2> <!-- XXX: this 'this_start_date' stuff appears not to work at e.g. https://nyc.councilmatic.org/events/ -->
                    <hr />
                    {% for date, event_list in month_events %}
                        {% include "partials/event_day.html" %}
                    {% endfor %}
                {% else %}
                    <h2>No {{ CITY_VOCAB.EVENTS | lower }} to show</h2>
                {% endif %}
            {% else %}
                {% if upcoming_events %}
                    <h2><span>Upcoming {{ CITY_VOCAB.EVENTS }}</span>
        			    <br class="non-desktop-only"/>
                    </h2>

                    <div class="modal-links">
                        {% if USING_NOTIFICATIONS %}
                            {% if user_subscribed %}
                            <a href="#" class="removeSubscription" data-toggle="tooltip" data-placement="top" title="Unsubscribe from events">
                                <i class="fa fa-envelope fa-fw" aria-hidden="true"></i> Subscribe
                            </a>
                            {% else %}
                                {% with link_id='eventsSubscribe' modal_id='meetings' custom_text='meetings' href='#' RSS_href='rss/' RSS_for='RSS feed for Upcoming and Recent Events' %}
                                    {% include 'partials/subscription_modal.html' %}
                                {% endwith %}
                            {% endif %}
                        {% else %}
                            <a href="rss/" title="RSS feed for Upcoming and Recent Events"><i class="fa fa-rss-square" aria-hidden="true"></i> RSS</a>
                        {% endif %}
                    </div>

                    <div class='row'>
                        <div class='col-sm-8' id='events_message'></div>
                    </div>
                    <hr/>
                    {% for date, event_list in upcoming_events %}
                        {% include "partials/event_day.html" %}
                    {% endfor %}
                {% else %}
                    <h2>
                        No Upcoming {{ CITY_VOCAB.EVENTS }}
                    </h2>

                    <div class="modal-links">
                        {% if USING_NOTIFICATIONS %}
                            {% if user_subscribed %}
                            <a href="#" class="removeSubscription" data-toggle="tooltip" data-placement="top" title="Unsubscribe from events">
                                <i class="fa fa-envelope fa-fw" aria-hidden="true"></i> Subscribe
                            </a>
                            {% else %}

                                {% with link_id='eventsSubscribe' modal_id='meetings' custom_text='meetings' href='#' RSS_href='rss/' RSS_for='RSS feed for Upcoming and Recent Events' %}
                                    {% include 'partials/subscription_modal.html' %}
                                {% endwith %}

                            {% endif %}
                        {% else %}
                           <a href="rss/" title="RSS feed for Upcoming and Recent Events"><i class="fa fa-rss-square" aria-hidden="true"></i> RSS</a>
                        {% endif %}
                    </div>

                    <div class='row'>
                        <div class='col-sm-8' id='events_message'></div>
                    </div>
                    <hr/>
                {% endif %}

            {% endif %}
        </div>

        <div class="col-sm-4 no-pad-mobile">
            <br/><br class="non-mobile-only"/>
            {% include 'partials/events_info_blurb.html' %}
        </div>
    </div>

{% endblock %}

{% block extra_js %}

    <script type="text/javascript" src="{% static 'js/bootstrap-datepicker.min.js' %}"></script>
    <script type="{% static 'js/moment.js' %}"></script>
    <script>
        $( ".dropdown-target" ).change(function() {
            var month = $("#month-dropdown").val()
            var year = $("#year-dropdown").val()
            var new_url = '/events/?year='+year+'&month='+month
            $("#view-events-btn").attr("href", new_url)
            });
    </script>

    {% if USING_NOTIFICATIONS %}
    <script>
    $(document).ready(function() {

        $("#form_datetime").datepicker({
            autoclose: true,
            viewMode: "months",
            minViewMode: "months",
        });

	    $("#eventsSubscribe").click(function() {
            var bullHorn    = $(this).parents().find(".createSubscription");
            var bullHornNew = $(this).parents().find(".removeSubscription");

            if ('{{ request.user }}' != 'AnonymousUser') {
			    posturl = "/events/subscribe/";
			    $.post(posturl, function(data) {
			    }).then( function() {
                    $(bullHorn).hide();
                    $(bullHornNew).show();
                }, function (error) {
                    console.error("Error subscribing to all events");
                });
            }
            else {
                $('#events_message').html(alertMsg);
            }

	   });
	});
    </script>
    {% endif %}

{% endblock %}
