{% extends "base_with_margins.html" %}
{% load extras %}
{% load staticfiles %}
{% block title %}Alerts{% endblock %}
{% block content %}

<div class="row-fluid">
    <div class="col-sm-12">
        <br class="non-mobile-only"/>
        <h1>
            <i class="fa fa-bullhorn fa-fw" aria-hidden="true"></i>
            Alerts
        </h1>
        <p>This page shows the {{ CITY_VOCAB.COUNCIL_MEMBERS | lower }}, committee actions, committee events, bill searches, bill actions, and {{ CITY_VOCAB.EVENTS | lower }} you are subscribed to.</p>
        <hr />

        <table class='table' id='subscriptions'>
            <thead>
                <tr>
                    <th>Alert Type</th>
                    <th>Name</th>
                    <th>RSS</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for subscription in person_subscriptions %}
                <tr class="subscription person"  person_id="{{subscription.person.id}}" person_slug ="{{subscription.person.slug}}">
                    <td>
                        <i class="fa fa-user fa-fw" aria-hidden="true"></i>
                        Council member
                    </td>
                    <td>
                        <a href="{% url 'person' subscription.person.slug %}">{{subscription.person }}</a>
                    </td>
                    <td>
                        <a href="{% url 'person_feed' subscription.person.slug %}" title="RSS feed for Sponsored Legislation by {{person.name}}"><i class="fa fa-rss-square" aria-hidden="true"></i></a>
                    </td>
                    <td align="left">
                        <div>
                        <input type="checkbox" class="removeButton" name="remove" style="float:left;">
                        <span style="display: none;">&nbsp;<button class="remove-subscription removePersonSubscription">Remove</button></span>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% for subscription in committee_action_subscriptions %}
                <tr class="subscription committee-action"  committee_id="{{subscription.committee.id}}" committee_slug ="{{subscription.committee.slug}}">
                    <td>
                        <i class="fa fa-users fa-fw" aria-hidden="true"></i>
                        Committee actions
                    </td>
                    <td>
                        <a href="{% url 'committee_detail' subscription.committee.slug %}">{{subscription.committee }}</a></td>
                    <td>
                        <a href="{% url 'committee_detail_action_feed' subscription.committee.slug %}" title="RSS feed for Actions for {{subscription.committee.name}}"><i class="fa fa-rss-square" aria-hidden="true"></i></a>
                    </td>
                    <td align="left">
                        <div>
                            <input type="checkbox" class="removeButton" name="remove" style="float:left;">
                            <span style="display: none;">&nbsp;<button class="remove-subscription removeCommitteeActionsSubscription">Remove</button></span>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% for subscription in committee_event_subscriptions %}
                <tr class="subscription committee-event"  committee_id="{{subscription.committee.id}}" committee_slug ="{{subscription.committee.slug}}">
                    <td>
                        <i class="fa fa-calendar-o fa-fw" aria-hidden="true"></i>
                        Committee events
                    </td>
                    <td>
                        <a href="{% url 'committee_detail' subscription.committee.slug %}">{{subscription.committee }}</a></td>
                    <td>
                        <a href="{% url 'committee_detail_events_feed' subscription.committee.slug %}" title="RSS feed for Events for {{subscription.committee.name}}"><i class="fa fa-rss-square" aria-hidden="true"></i></a>
                    </td>
                    <td align="left">
                        <div>
                        <input type="checkbox" class="removeButton" name="remove" style="float:left;">
                        <span style="display: none;">&nbsp;<button class="remove-subscription removeCommitteeEventsSubscription">Remove</button></span>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% for subscription in bill_search_subscriptions %}
                <tr class="subscription bill-search"  subscription_id="{{subscription.id}}" search_term="{{subscription.search_term}}" search_facets='{{subscription.search_facets|jsonify}}'>
                    <td>
                        <i class="fa fa-search fa-fw" aria-hidden="true"></i>
                        Bill search
                    </td>
                    <td>
                        <b>Search term:</b> 
                        <a href="{{ subscription|custom_reverse_search_url }}">
                            {{subscription.search_term }}
                        </a>
                        <br/>
                        <span class="small text-muted">
                        {% for key, values in subscription.search_facets.items %}
                            <b>{{key}}</b>:
                            {% for v in values %}
                                {{v}}
                            {% endfor %} <br/>
                        {% endfor %}
                        </span>

                    </td>
                    <td>
                        <a href="{# url 'councilmatic_search_feed' subscription.search_term #}" title="RSS feed for Actions for {{subscription.committee.name}}"><i class="fa fa-rss-square" aria-hidden="true"></i></a>
                    </td>
                    <td align="left">
                        <div>
                            <input type="checkbox" class="removeButton" name="remove" style="float:left;">
                            <span style="display: none;">&nbsp;<button class="remove-subscription removeBillSearchSubscription">Remove</button></span>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% for subscription in bill_action_subscriptions %}
                <tr class="subscription bill-action"  bill_id="{{subscription.bill.id}}" bill_slug ="{{subscription.bill.slug}}">
                    <td>
                        <i class="fa fa-list-ul fa-fw" aria-hidden="true"></i>
                        Bill actions
                    </td>
                    <td>
                        <a href="{% url 'bill_detail' subscription.bill.slug %}">{{subscription.bill}}</a></td>
                    <td>
                        <a href="{% url 'bill_detail_action_feed' subscription.bill.slug %}" title="RSS feed for Actions for {{subscription.bill.name}}"><i class="fa fa-rss-square" aria-hidden="true"></i></a>
                    </td>
                    <td align="left">
                        <div>
                            <input type="checkbox" class="removeButton" name="remove" style="float:left;">
                            <span style="display: none;">&nbsp;<button class="remove-subscription removeBillActionsSubscription">Remove</button></span>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% for subscription in events_subscriptions %} {# When the only possible subscription is for "all" events, there should only be one #}
                <tr class="subscription events" subscription_id="{{subscription.id}}">
                    <td>
                        <i class="fa fa-calendar-o fa-fw" aria-hidden="true"></i>
                        {{ CITY_VOCAB.EVENTS }}
                    </td>
                    <td>
                        All
                    </td>
                    <td align="left">
                        <div>
                            <input type="checkbox" class="removeButton" name="remove" style="float:left;">
                            <span style="display: none;">&nbsp;<button class="remove-subscription removeEventsSubscription">Remove</button></span>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                </div>
            </tbody>
        </table>
    </div>
</div>

    <!-- XXX TODO: figure out why this "No Subscriptions" headers isn't working -->
    <!-- 
    {% if not person_subscriptions and not committee_event_subscriptions and not committee_event_subscriptions and not bill_action_subscriptions and not bill_search_subscriptions and not events_subscriptions %}
     <div class="row-fluid">
             <div class="col-sm-8 table-col">
             <h3>No Subscriptions Found.</h3>
         </div>
     </div>
    {% endif %}
    -->


{% endblock %}
{% block extra_js %}
    <script src="{% static 'js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'js/jquery.dataTables.sorting.js' %}"></script>
    <script src="{% static 'js/dataTables.bootstrap.js' %}"></script>

    <script>
    // remove the actual interest

    function removeSubscription(container) {

        if(container.hasClass("person")){
            var slug = container.attr("person_slug");
            var del_url = "/person/" + slug + "/unsubscribe/"
        } else if(container.hasClass("committee-action")){
            var slug = container.attr("committee_slug");
            var del_url = "/committee/" + slug + "/actions/unsubscribe/"
        } else if(container.hasClass("committee-event")){
            var slug = container.attr("committee_slug");
            var del_url = "/committee/" + slug + "/events/unsubscribe/"
        } else if(container.hasClass("bill-search")){
            var slug = container.attr("subscription_id");
            var del_url = '/search_unsubscribe/' + slug + '/'
        } else if(container.hasClass("bill-action")){
            var slug = container.attr("bill_slug");
            var del_url = "/legislation/" + slug + "/unsubscribe/"
        } else if(container.hasClass("events")){
            var del_url = "/events/unsubscribe/"
        }

        $.post(del_url, function(data){
            console.log("deleted "+del_url);
            container.remove();
        }).error(function(){
            console.log("error deleting "+del_url)
        });

    }

    // Add callbacks for hidden "remove" buttons
    // 1. Person Subscriptions
    // 2. Committee Actions Subscriptions
    // 3. Committee Events Subscriptions
    // 4. Bill Search Subscriptions
    // 5. Bill Actions Subscriptions
    // 6. Events Subscriptions
    $("button.remove-subscription").click(function () {
        var container = $(this).parents(".subscription");
        removeSubscription(container)
    });


    $("input.removeButton").click(function() {
        // find the adjacent button and make it visible
        button = $(this).next();
        if ($(this).is(":checked")) {
            button.css("display", "block");
        }
        else {
            button.css("display", "none");
        }
    });

        $("#committees").DataTable({
            "info": false,
            "searching": false,
            "bLengthChange": false,
            "paging": false,
            "aaSorting": [ [0,'asc'] ],
            "aoColumns": [
                null,
                null,
                null
            ]
        });

        $("#subcommittees").DataTable({
            "info": false,
            "searching": false,
            "bLengthChange": false,
            "paging": false,
            "aaSorting": [ [0,'asc'] ],
            "aoColumns": [
                null,
                null,
                null
            ]
        });

        $("#taskforces").DataTable({
            "info": false,
            "searching": false,
            "bLengthChange": false,
            "paging": false,
            "aaSorting": [ [0,'asc'] ],
            "aoColumns": [
                null,
                null,
                null
            ]
        });
    </script>
{% endblock %}
